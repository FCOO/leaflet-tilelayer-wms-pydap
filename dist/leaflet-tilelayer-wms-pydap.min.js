!function(a,b,c,d,e){"use strict";function f(a){this.name="MetadataError",this.message=a||"Default Message",this.stack=(new Error).stack}var g="https:"==c.location.protocol?"https:":"http:";f.prototype=Object.create(Error.prototype),f.prototype.constructor=f,b.TileLayer.WMS.Pydap=b.TileLayer.WMS.extend({baseUrl:g+"//{s}.fcoo.dk/webmap/{dataset}.wms",defaultWmsParams:{service:"WMS",request:"GetMap",version:"1.1.1",layers:"",styles:"",format:"image/png",transparent:!0},defaultLegendParams:{request:"GetColorbar",styles:"horizontal,nolabel",cmap:"",show:!1,imageUrl:null,position:"bottomleft",attribution:null},options:{language:"en",bounds:null,tileSize:512,opacity:1,updateInterval:50,subdomains:["wms01","wms02","wms03","wms04"],maxZoom:18,primadonna:!0,foreground:null,crs:b.CRS.EPSG3857,attribution:'Weather from <a href="http://fcoo.dk/" alt="Defence Centre for Operational Oceanography">FCOO</a>',onMetadataError:function(a){throw c.noty({text:a.message,type:"error"}),a}},initialize:function(c,d,f,g){var h=this;this._basetileurl=this.baseUrl.replace("{dataset}",c),this._map=null,this._legendControl=null,this._legendId=null,this._dataset=c,this._gotMetadata=!1,this.levels=e,this.timesteps=null,b.TileLayer.WMS.prototype.initialize.call(this,this._basetileurl,d),b.Util.setOptions(this,g),f!==e&&f.show!==!1&&(f.show=!0,f.cmap===e&&(f.cmap=this.wmsParams.cmap)),this.on("load",function(){this._pruneTiles()}),this.legendParams={},a.extend(this.legendParams,this.defaultLegendParams,f),jQuery.support.cors=!0;var i;i=this.options.hasOwnProperty("ajaxProxy")?c.length:c.length+this.wmsParams.layers.length,i%=this.options.subdomains.length,this._fcootileurl=b.Util.template(this._basetileurl,{s:this.options.subdomains[i]}),this.ajaxOptions={url:this._fcootileurl,timeout:3e4,tryCount:0,retryLimit:2,data:{SERVICE:"WMS",REQUEST:"GetMetadata",VERSION:this.wmsParams.version,ITEMS:"epoch,last_modified,long_name,units,bounds,time,levels",LAYERS:this.wmsParams.layers.split(":")[0].split(",")[0]},context:this,error:function(b,c,d){return!h.options.hasOwnProperty("ajaxProxy")&&"timeout"==c&&(this.ajaxOptions.tryCount++,this.ajaxOptions.tryCount<=this.ajaxOptions.retryLimit)?void a.ajax(this.ajaxOptions):void this._error_metadata(b,c,d)},success:function(a){this._got_metadata(a)},beforeSend:function(a,b){a.url=b.url},cache:!0,dataType:"json",async:!0},this.options.hasOwnProperty("ajaxProxy")?this.options.ajaxProxy.deferredAjax(this.ajaxOptions):a.ajax(this.ajaxOptions)},setParamsListener:function(a){"current"!==this.wmsParams.time&&this.setParams({time:a.datetime},!1,!0)},setParams:function(a,c,d){return b.extend(this.wmsParams,a),c||(this._abortLoading(),this._map&&this.redraw(d)),this},redraw:function(a){return this._map&&(a?this._pruneTiles():this._removeAllTiles(),this._update()),this},_tileCoordsToKey:function(a){return a.x+":"+a.y+":"+a.z+":"+a.t},_update:function(a){var c,f,g=this._map;if(g&&this.wmsParams.time){var h=g.getZoom();if(a===e&&(a=g.getCenter()),this._tileZoom!==e){var i=this._getTiledPixelBounds(a),j=this._pxBoundsToTileRange(i),k=j.getCenter(),l=[];for(var m in this._tiles)this._tiles[m].current=!1;if(Math.abs(h-this._tileZoom)>1)return void this._setView(a,h);for(f=j.min.y;f<=j.max.y;f++)for(c=j.min.x;c<=j.max.x;c++){var n=new b.Point(c,f);if(n.z=this._tileZoom,n.t=this.wmsParams.time,this._isValidTile(n)){var o=this._tiles[this._tileCoordsToKey(n)];o?o.current=!0:l.push(n)}}if(l.sort(function(a,b){return a.distanceTo(k)-b.distanceTo(k)}),0!==l.length){this._loading||(this._loading=!0,this.fire("loading"));var p=d.createDocumentFragment();for(c=0;c<l.length;c++)this._addTile(l[c],p);this._level.el.appendChild(p)}}}},_abortLoading:function(){var a,c;for(a in this._tiles)this._tiles[a].coords.z===this._tileZoom&&this._tiles[a].coords.t===this.wmsParams.time||(c=this._tiles[a].el,c.onload=b.Util.falseFn,c.onerror=b.Util.falseFn,c.complete||(c.src=b.Util.emptyImageUrl,b.DomUtil.remove(c)))},prefetch:function(){},prefetchAll:function(){var a=this.timesteps,b=function(a,b){var c=moment(a),d=0;if(c!==e)for(var f in b)if(c.isSame(moment(b[f]))){d=f+1,d>b.length-1&&(d=0);break}return d},c=b(this.wmsParams.time,this.timesteps),d=function(){c+=1,c>a.length-1&&(c=0);var b=moment(a[c]);b=b.format("YYYY-MM-DDTHH:mm:ss.SSS")+"Z"},f=moment(a[c]);f=f.format("YYYY-MM-DDTHH:mm:ss.SSS")+"Z";var g={time:f};this.prefetch(g,d)},abortPrefetch:function(){this._cacheLayer.on("load",function(){},this)},getTileUrl:function(a){function c(a){return parseInt(a,10)}var d,f=!0,h=this.wmsParams.time;if(h!==e&&"current"!==h){var i=h.split("T");if(2==i.length){var j=i[0].split("-").map(c),k=i[1].split(":").map(c),l=new Date(Date.UTC(j[0],j[1]-1,j[2],k[0],k[1],k[2])),m=this.timesteps;null!==m&&(l<m[0]||l>m[m.length-1])&&(f=!1)}}return f?d=b.TileLayer.WMS.prototype.getTileUrl.call(this,a):(d=g+"//tiles.fcoo.dk/tiles/empty_512.png",this._removeAllTiles()),d},_error_metadata:function(a,b,c){var d;d="timeout"==b?"Web map metadata request timed out: "+a.url:"error"==b?"Web map metadata request failed: "+a.url+" with message="+a.responseText:"Web map metadata error: "+a.url+" due exception type="+b+" with server message="+a.responseText+" and client message="+c.message,this.options.onMetadataError(new f(d))},_got_metadata:function(a){try{"epoch"in a&&(this._epoch=moment(a.epoch)),"last_modified"in a&&(this._last_modified=moment(a.last_modified));var c=this.wmsParams.layers.split(":")[0].split(",")[0];if(!(c in a))throw new f("Cannot find "+c+" in "+a);var d=a[c];if(this._long_name=d.long_name,this._units=d.units,"levels"in d&&(this.levels=d.levels),"bounds"in d){var e=d.bounds;e[0]=e[0]>180?e[0]-360:e[0],e[2]=e[2]>180?e[2]-360:e[2],this.options.bounds=b.latLngBounds(b.latLng(e[1],e[0]),b.latLng(e[3],e[2]))}if("time"in d){for(var g=function(a){return parseInt(a,10)},h=d.time,i=[],j=0;j<h.length;j++){var k=h[j].split("T"),l=k[0].split("-").map(g),m=k[1].split(":").map(g),n=new Date(Date.UTC(l[0],l[1]-1,l[2],m[0],m[1],m[2]));i[j]=new Date(n)}this.timesteps=i}this._gotMetadata=!0}catch(o){this.options.onMetadataError(new f(o.message))}},getLegendUrl:function(){var a={request:this.legendParams.request,styles:this.legendParams.styles,cmap:this.legendParams.cmap},c=b.Util.getParamString(a);return c},onAdd:function(a){var c=this;this._map=a,a.on("datetimechange",this.setParamsListener,this),null!==c.options.foreground&&c.options.foreground.addTo(a);var d=function(){if(c._gotMetadata){if(c.legendParams.show&&(c._legendControl=c._getLegendControl(),null!==c._legendControl&&(c.legendParams.show&&(c.legendParams.imageUrl=c._fcootileurl+c.getLegendUrl()),c.legendParams.show&&null!==c.legendParams.imageUrl))){c.legendParams.longName===e&&(c.legendParams.longName=c._long_name),c.legendParams.units===e&&(c.legendParams.units=c._units);var f={imageUrl:c.legendParams.imageUrl,attribution:c.legendParams.attribution,lastUpdated:c._last_modified,epoch:c._epoch,updatesPerDay:c.legendParams.updatesPerDay,longName:c.legendParams.longName,units:c.legendParams.units};c._legendId=c._legendControl.addLegend(f)}if(c.levels!==e&&a.on("levelchange",function(a){c.setParams({level:a.index},!1,!1)}),c.wmsParams.time===e){var g=moment(c.timesteps[0]);g=g.format("YYYY-MM-DDTHH:mm:ss.SSS")+"Z",c.wmsParams.time=g}b.TileLayer.WMS.prototype.onAdd.call(c,a)}else setTimeout(d,10)};d()},onRemove:function(a){null!==this._legendControl&&(this._legendControl.removeLegend(this._legendId),this._legendControl=null,this._legendId=null),null!==this.options.foreground&&this.options.foreground.removeFrom(a),a.off("datetimechange",this.setParamsListener,this),this.levels!==e&&a.off("levelchange",this),this._map=null,b.TileLayer.WMS.prototype.onRemove.call(this,a)},_getLegendControl:function(){return"undefined"!=typeof this._map._fcoo_legendcontrol&&this._map._fcoo_legendcontrol||(this._map._fcoo_legendcontrol=new b.Control.Legend({position:this.legendParams.position,language:this.options.language}),this._map.addControl(this._map._fcoo_legendcontrol)),this._map._fcoo_legendcontrol}})}(jQuery,L,this,document);;!function(a,b,c,d){"use strict";var e={requests:[],deferredAjax:function(a){this.requests.push(a)},doAjax:function(){var b=this.mergeRequests();for(var c in b)b.hasOwnProperty(c)&&a.ajax(b[c])},mergeRequests:function(){var b,c={},e=this.requests.length;for(b=0;b<e;b++){var f=this.requests[b];c.hasOwnProperty(f.url)?c[f.url].push(f):c[f.url]=[f]}var g={};for(var h in c)if(c.hasOwnProperty(h)){g[h]={};var i=c[h],j=i.length;g[h].tryCount=i[0].tryCount,g[h].retryLimit=i[0].retryLimit,g[h].url=i[0].url,g[h].timeout=i[0].timeout,g[h].beforeSend=i[0].beforeSend,g[h].cache=i[0].cache,g[h].dataType=i[0].dataType,g[h].async=i[0].async,g[h].data=i[0].data,g[h].context=[];var k=[];for(b=0;b<j;b++)g[h].context.push({key:h,context:i[b].context,success:i[b].success,error:i[b].error}),k.indexOf(i[b].data.LAYERS)==-1&&k.push(i[b].data.LAYERS);g[h].data.LAYERS=k.join(),g[h].success=function(a,b,c){for(var d=this.length,e=0;e<d;e++)this[e].success.call(this[e].context,a,b,c)},g[h].error=function(b,c,e){var f=this.length;if("timeout"==c)for(var h=0;h<f;h++){if(this[h].context.ajaxOptions.tryCount!==d&&this[h].context.ajaxOptions.retryLimit!==d&&(this[h].context.ajaxOptions.tryCount++,this[h].context.ajaxOptions.tryCount<=this[h].context.ajaxOptions.retryLimit))return void a.ajax(g[this[h].key]);break}for(var i=0;i<f;i++)this[i].error.call(this[i].context,b,c,e)}}return g}};b.WmsAjaxProxy=e}(jQuery,this,document);
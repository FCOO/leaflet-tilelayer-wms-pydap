!function(a,b,c,d,e){"use strict";function f(a){this.name="MetadataError",this.message=a||"Default Message",this.stack=(new Error).stack}var g="https:"==c.location.protocol?"https:":"http:";f.prototype=Object.create(Error.prototype),f.prototype.constructor=f,b.TileLayer.WMS.Pydap=b.TileLayer.WMS.extend({baseUrl:g+"//{s}.fcoo.dk/webmap/{dataset}.wms",defaultWmsParams:{service:"WMS",request:"GetMap",version:"1.1.1",layers:"",styles:"",format:"image/png",transparent:!0},defaultLegendParams:{request:"GetColorbar",styles:"horizontal,nolabel",cmap:"",show:!1,imageUrl:null,position:"bottomleft",attribution:null},options:{language:"en",bounds:null,tileSize:512,opacity:1,updateInterval:50,subdomains:["wms01","wms02","wms03","wms04"],maxZoom:18,primadonna:!0,foreground:null,crs:b.CRS.EPSG3857,attribution:'Weather from <a href="http://fcoo.dk/" alt="Defence Centre for Operational Oceanography">FCOO</a>',onMetadataError:function(a){throw c.noty({text:a.message,type:"error"}),a}},initialize:function(c,d,f,g){this._basetileurl=this.baseUrl.replace("{dataset}",c),this._map=null,this._legendControl=null,this._legendId=null,this._dataset=c,this._gotMetadata=!1,this.levels=e,this.timesteps=null,b.TileLayer.WMS.prototype.initialize.call(this,this._basetileurl,d),b.Util.setOptions(this,g),f!==e&&f.show!==!1&&(f.show=!0,f.cmap===e&&(f.cmap=this.wmsParams.cmap)),this.on("load",function(){this._pruneTiles()}),this.legendParams={},a.extend(this.legendParams,this.defaultLegendParams,f),jQuery.support.cors=!0;var h;h=this.options.hasOwnProperty("ajaxProxy")?c.length:c.length+this.wmsParams.layers.length,h%=this.options.subdomains.length,this._fcootileurl=b.Util.template(this._basetileurl,{s:this.options.subdomains[h]});var i={url:this._fcootileurl,data:{SERVICE:"WMS",REQUEST:"GetMetadata",VERSION:this.wmsParams.version,ITEMS:"epoch,last_modified,long_name,units,bounds,time,levels",LAYERS:this.wmsParams.layers.split(":")[0].split(",")[0]},context:this,error:this._error_metadata,success:this._got_metadata,beforeSend:function(a,b){a.url=b.url},cache:!0,dataType:"json",async:!0};this.options.hasOwnProperty("ajaxProxy")?this.options.ajaxProxy.deferredAjax(i):a.ajax(i)},setParamsListener:function(a){"current"!==this.wmsParams.time&&this.setParams({time:a.datetime},!1,!0)},setParams:function(a,c,d){return b.extend(this.wmsParams,a),c||(this._abortLoading(),this._map&&this.redraw(d)),this},redraw:function(a){return this._map&&(a?this._pruneTiles():this._removeAllTiles(),this._update()),this},_tileCoordsToKey:function(a){return a.x+":"+a.y+":"+a.z+":"+a.t},_update:function(a){var c,f,g=this._map;if(g&&this.wmsParams.time){var h=g.getZoom();if(a===e&&(a=g.getCenter()),this._tileZoom!==e){var i=this._getTiledPixelBounds(a),j=this._pxBoundsToTileRange(i),k=j.getCenter(),l=[];for(var m in this._tiles)this._tiles[m].current=!1;if(Math.abs(h-this._tileZoom)>1)return void this._setView(a,h);for(f=j.min.y;f<=j.max.y;f++)for(c=j.min.x;c<=j.max.x;c++){var n=new b.Point(c,f);if(n.z=this._tileZoom,n.t=this.wmsParams.time,this._isValidTile(n)){var o=this._tiles[this._tileCoordsToKey(n)];o?o.current=!0:l.push(n)}}if(l.sort(function(a,b){return a.distanceTo(k)-b.distanceTo(k)}),0!==l.length){this._loading||(this._loading=!0,this.fire("loading"));var p=d.createDocumentFragment();for(c=0;c<l.length;c++)this._addTile(l[c],p);this._level.el.appendChild(p)}}}},_abortLoading:function(){var a,c;for(a in this._tiles)this._tiles[a].coords.z===this._tileZoom&&this._tiles[a].coords.t===this.wmsParams.time||(c=this._tiles[a].el,c.onload=b.Util.falseFn,c.onerror=b.Util.falseFn,c.complete||(c.src=b.Util.emptyImageUrl,b.DomUtil.remove(c)))},prefetch:function(){},prefetchAll:function(){var a=this.timesteps,b=function(a,b){var c=moment(a),d=0;if(c!==e)for(var f in b)if(c.isSame(moment(b[f]))){d=f+1,d>b.length-1&&(d=0);break}return d},c=b(this.wmsParams.time,this.timesteps),d=function(){c+=1,c>a.length-1&&(c=0);var b=moment(a[c]);b=b.format("YYYY-MM-DDTHH:mm:ss.SSS")+"Z"},f=moment(a[c]);f=f.format("YYYY-MM-DDTHH:mm:ss.SSS")+"Z";var g={time:f};this.prefetch(g,d)},abortPrefetch:function(){this._cacheLayer.on("load",function(){},this)},getTileUrl:function(a){function c(a){return parseInt(a,10)}var d,f=!0,h=this.wmsParams.time;if(h!==e&&"current"!==h){var i=h.split("T");if(2==i.length){var j=i[0].split("-").map(c),k=i[1].split(":").map(c),l=new Date(Date.UTC(j[0],j[1]-1,j[2],k[0],k[1],k[2])),m=this.timesteps;null!==m&&(l<m[0]||l>m[m.length-1])&&(f=!1)}}return f?d=b.TileLayer.WMS.prototype.getTileUrl.call(this,a):(d=g+"//tiles.fcoo.dk/tiles/empty_512.png",this._removeAllTiles()),d},_error_metadata:function(a){var b="Failed getting web map metadata from "+a.url;this.options.onMetadataError(new f(b))},_got_metadata:function(a){try{"epoch"in a&&(this._epoch=moment(a.epoch)),"last_modified"in a&&(this._last_modified=moment(a.last_modified));var c=a[this.wmsParams.layers.split(":")[0].split(",")[0]];if(this._long_name=c.long_name,this._units=c.units,"levels"in c&&(this.levels=c.levels),"bounds"in c){var d=c.bounds;d[0]=d[0]>180?d[0]-360:d[0],d[2]=d[2]>180?d[2]-360:d[2],this.options.bounds=b.latLngBounds(b.latLng(d[1],d[0]),b.latLng(d[3],d[2]))}if("time"in c){for(var e=function(a){return parseInt(a,10)},g=c.time,h=[],i=0;i<g.length;i++){var j=g[i].split("T"),k=j[0].split("-").map(e),l=j[1].split(":").map(e),m=new Date(Date.UTC(k[0],k[1]-1,k[2],l[0],l[1],l[2]));h[i]=new Date(m)}this.timesteps=h}this._gotMetadata=!0}catch(n){this.options.onMetadataError(new f(n.message))}},getLegendUrl:function(){var a={request:this.legendParams.request,styles:this.legendParams.styles,cmap:this.legendParams.cmap},c=b.Util.getParamString(a);return c},onAdd:function(a){var c=this;this._map=a,a.on("datetimechange",this.setParamsListener,this),null!==c.options.foreground&&c.options.foreground.addTo(a);var d=function(){if(c._gotMetadata){if(c.legendParams.show&&(c._legendControl=c._getLegendControl(),null!==c._legendControl&&(c.legendParams.show&&(c.legendParams.imageUrl=c._fcootileurl+c.getLegendUrl()),c.legendParams.show&&null!==c.legendParams.imageUrl))){c.legendParams.longName===e&&(c.legendParams.longName=c._long_name),c.legendParams.units===e&&(c.legendParams.units=c._units);var f={imageUrl:c.legendParams.imageUrl,attribution:c.legendParams.attribution,lastUpdated:c._last_modified,epoch:c._epoch,updatesPerDay:c.legendParams.updatesPerDay,longName:c.legendParams.longName,units:c.legendParams.units};c._legendId=c._legendControl.addLegend(f)}if(c.levels!==e&&a.on("levelchange",function(a){c.setParams({level:a.index},!1,!1)}),c.wmsParams.time===e){var g=moment(c.timesteps[0]);g=g.format("YYYY-MM-DDTHH:mm:ss.SSS")+"Z",c.wmsParams.time=g}b.TileLayer.WMS.prototype.onAdd.call(c,a)}else setTimeout(d,10)};d()},onRemove:function(a){null!==this._legendControl&&(this._legendControl.removeLegend(this._legendId),this._legendControl=null,this._legendId=null),null!==this.options.foreground&&this.options.foreground.removeFrom(a),a.off("datetimechange",this.setParamsListener,this),this.levels!==e&&a.off("levelchange",this),this._map=null,b.TileLayer.WMS.prototype.onRemove.call(this,a)},_getLegendControl:function(){return"undefined"!=typeof this._map._fcoo_legendcontrol&&this._map._fcoo_legendcontrol||(this._map._fcoo_legendcontrol=new b.Control.Legend({position:this.legendParams.position,language:this.options.language}),this._map.addControl(this._map._fcoo_legendcontrol)),this._map._fcoo_legendcontrol}})}(jQuery,L,this,document);;!function(a,b,c,d){"use strict";var e={requests:[],deferredAjax:function(a){this.requests.push(a)},doAjax:function(){var b=this.mergeRequests();for(var c in b)b.hasOwnProperty(c)&&a.ajax(b[c])},mergeRequests:function(){var a,b={},c=this.requests.length;for(a=0;c>a;a++){var d=this.requests[a];b.hasOwnProperty(d.url)?b[d.url].push(d):b[d.url]=[d]}var e={};for(var f in b)if(b.hasOwnProperty(f))if(e[f]={},1==b[f].length)e[f]=b[f][0];else{var g=b[f],h=g.length;e[f].url=g[0].url,e[f].beforeSend=g[0].beforeSend,e[f].cache=g[0].cache,e[f].dataType=g[0].dataType,e[f].async=g[0].async,e[f].data=g[0].data,e[f].context=[];var i=[];for(a=0;h>a;a++)e[f].context.push({context:g[a].context,success:g[a].success,error:g[a].error}),-1==i.indexOf(g[a].data.LAYERS)&&i.push(g[a].data.LAYERS);e[f].data.LAYERS=i.join(),e[f].success=function(a,b,c){for(var d=this.length,e=0;d>e;e++)this[e].success.call(this[e].context,a,b,c)},e[f].error=function(a,b,c){for(var d=this.length,e=0;d>e;e++)this[e].error.call(this[e].context,a,b,c)}}return e}};b.WmsAjaxProxy=e}(jQuery,this,document);